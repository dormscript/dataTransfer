<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Datatransfer by dormscript</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Datatransfer</h1>
      <h2 class="project-tagline">数据迁移框架</h2>
      <a href="https://github.com/dormscript/dataTransfer" class="btn">View on GitHub</a>
      <a href="https://github.com/dormscript/dataTransfer/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/dormscript/dataTransfer/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h2>
<a id="应用场景" class="anchor" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>应用场景</h2>

<p>网站升级改版时，如果数据结构发生较大修改，就需要将数据从源数据库迁移到新的数据库，同时数据表名、字段名都需要较大修改。涉及到的修改包括：表名修改、字段名修改，字段内的数据格式转换，数据记录过滤（无效数据不再需要转换到新的数据表），多张表合并到一张表，一张表拆分为多张表。</p>

<h2>
<a id="解决的问题" class="anchor" href="#%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>解决的问题：</h2>

<ul>
<li>封装数据迁移的公共部分</li>
<li>数据迁移时的表、字段对应关系</li>
<li>提供并行处理</li>
<li>同步数据迁移过程中的增量数据变更（需要借助第三方工具）</li>
<li>提供数据迁移后的后续操作，例如更新memcache缓存，通知第三方全文检索等</li>
<li>提供简易的数据迁移进度查看界面，动态调整处理进程数</li>
</ul>

<h2>
<a id="用到的技术" class="anchor" href="#%E7%94%A8%E5%88%B0%E7%9A%84%E6%8A%80%E6%9C%AF" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>用到的技术：</h2>

<ul>
<li>PHP</li>
<li>Swoole</li>
</ul>

<h2>
<a id="适用场景" class="anchor" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>适用场景：</h2>

<ul>
<li>将源数据库中的表迁移到新的数据库</li>
<li>将源数据库中的表进行合并迁移到新数据库</li>
<li>将源数据库中的数据按照一定规则处理后写到新的数据库</li>
<li>将源数据库中的数据按照一定规则过滤，将过滤后的结果写到新的数据库</li>
</ul>

<h2>
<a id="场景1用法介绍" class="anchor" href="#%E5%9C%BA%E6%99%AF1%E7%94%A8%E6%B3%95%E4%BB%8B%E7%BB%8D" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>场景1用法介绍：</h2>

<p>将源数据库的user表迁移到新数据库的newUser.user表</p>

<pre><code>1：vim config.php，配置源、目标数据库的ip、用户名、密码
2：进入Models目录，创建子目录，目录名为源数据库的库名
3：进入新创建的目录，创建文件，格式为：{$tableName}.php
4：内容见Models\usercenter\user.php
5：设置需要多少个进程来处理数据迁移。vim config.php，配置setting
5：进入根目录执行：  php main.php
</code></pre>

<h2>
<a id="场景2用法" class="anchor" href="#%E5%9C%BA%E6%99%AF2%E7%94%A8%E6%B3%95" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>场景2用法：</h2>

<p>将源数据库的user表、user_contact合并，迁移到新数据库的newUser.user表</p>

<pre><code>代码见user1.php
</code></pre>

<h2>
<a id="场景34用法" class="anchor" href="#%E5%9C%BA%E6%99%AF34%E7%94%A8%E6%B3%95" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>场景3、4用法：</h2>

<p>将源数据库的user表迁移到新数据库的newUser.user表，同时将sex字段的0改为男，1改为女。如果sex为其它值，不迁移此条记录</p>

<pre><code>代码见user2.php
</code></pre>

<h2>
<a id="callback的使用" class="anchor" href="#callback%E7%9A%84%E4%BD%BF%E7%94%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>callback的使用：</h2>

<pre><code>代码见user2.php中的callback函数
</code></pre>

<p><strong>需要注意：callback函数接收到的参数默认是源数据库中的记录。如果需要使用转换后的记录，需要一行设置：</strong>
    public $callbackRow  = 'desc'; </p>

<h2>
<a id="附fieldmap支持的格式" class="anchor" href="#%E9%99%84fieldmap%E6%94%AF%E6%8C%81%E7%9A%84%E6%A0%BC%E5%BC%8F" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>附：fieldmap支持的格式：</h2>

<ul>
<li>
<p>一对一</p>

<pre><code>'username' =&gt; 'username'
说明：将源表的username字段原样转到新表的username字段
</code></pre>
</li>
<li>
<p>一对一，格式转换</p>

<pre><code>'pid' =&gt; 'pid/getNewpid'
说明：使用自定义函数将源表的pid字段转换后存入新表的pid字段
例 ： 
public function getNewPid($p)
{
    return ($p + 1000000001);
}
</code></pre>
</li>
<li>
<p>一对一，格式转换、数据过滤</p>

<pre><code>'state'  =&gt; 'status/getStatus',
说明：使用自定义函数getstatus处理status字段。
如果getstatus函数返回值为false，当前记录会被忽略。返回其它值，将返回值存入新表
public function getstatus () {
    if(in_array($status, 1,2,3)) {
        //只迁移状态为1、2、3数据
        return $status;
    } else {
        //其它状态的数据不再迁移
        return false;
    }
}
</code></pre>
</li>
<li>
<p>多对一</p>

<pre><code>'prokey' =&gt; 'prokey,prokeyword/getkey',
说明：将两个字段经过getkey函数处理后（返回值是字符串），存入新表的prokey字段
</code></pre>
</li>
<li>
<p>多对多</p>

<pre><code>'cate1-cate2-cate3' =&gt; 'cate1,cate2,cate3/getCate',
说明：getcate函数接收1个参数（数组），返回值为一个数组。
</code></pre>
</li>
<li>
<p>将新表的字段设默认值</p>

<pre><code>'newfieldname' =&gt; '4/returnme',
</code></pre>
</li>
</ul>

<h2>
<a id="其它用途" class="anchor" href="#%E5%85%B6%E5%AE%83%E7%94%A8%E9%80%94" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>其它用途：</h2>

<pre><code>可以将此框架做为简单的并行读数据框架，callback中写自己需要做的事情。
例：user3.php
</code></pre>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/dormscript/dataTransfer">Datatransfer</a> is maintained by <a href="https://github.com/dormscript">dormscript</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
